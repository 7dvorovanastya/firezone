---
- name: provision deps
  hosts: all
  become: yes
  tasks:
    - name: install deps
      apt:
        install_recommends: no
        autoclean: yes
        autoremove: yes
        update_cache: true
        pkg:
          - sudo
          - git
          - curl
          - gnupg
          - unzip
          - wireguard
          - postgresql
          - iptables
- name: Configure System
  hosts: all
  become: yes
  tasks:
    - name: copy files
      shell: |
        cp /vagrant/ansible/sample_conf/wg-server.conf /etc/wireguard/wg0.conf
    - name: ensure ipv4 forward
      lineinfile:
        path: /etc/sysctl.conf
        line: 'net.ipv4.ip_forward = 1'
    - name: ensure ipv6 forward
      lineinfile:
        path: /etc/sysctl.conf
        line: 'net.ipv6.conf.all.forwarding = 1'
    - name: apply sysctl
      shell: sysctl -p
# - name: Bootstrap DB
#   hosts: all
#   tasks:
#     - name: generate database url
#       lineinfile:
#         create: yes
#         path: /home/vagrant/.fireguard-rc
#         line: "DATABASE_URL=ecto://fireguard:{{ lookup('password', '/tmp/postgres_passwd') }}/fireguard"
#         regexp: "DATABASE_URL"
#     - name: add fireguard user
#       shell: |
#         sudo -i -u postgres psql -c "CREATE ROLE fireguard WITH LOGIN PASSWORD '{{ lookup('password', '/tmp/postgres_passwd') }}';"
#         sudo -i -u postgres psql -c "CREATE DATABASE fireguard;"
#         sudo -i -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE fireguard to fireguard;"
# - name: Bootstrap App
#   hosts: all
#   tasks:
#     - name: generate secret key base
#       lineinfile:
#         path: /home/vagrant/.fireguard-rc
#         line: "SECRET_KEY_BASE={{ lookup('password', '/tmp/secret_key_base chars=hexdigits length=64') }}"
#         regexp: "SECRET_KEY_BASE"
